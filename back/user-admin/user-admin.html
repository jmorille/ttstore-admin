<link rel="import" href="../components/polymer/polymer.html">

<link rel="import" href="../components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../components/paper-button/paper-button.html" >
<link rel="import" href="../components/paper-toast/paper-toast.html" >

<link rel="import" href="../user-admin/user-service.html">
<link rel="import" href="../user-admin/user-list.html">
<link rel="import" href="../user-admin/user-edit.html">


<polymer-element name="user-admin" attributes="">

    <template>
        <style>
            :host {
                display: block;
            }
            .toast-error {
                background-color: red;
            }
        </style>
        <user-service id="user_service" response="{{entity}}"></user-service>

        <core-animated-pages selected="{{pageSelected}}"
                             flex auto>

            <user-list id="list" name="entityList" data="{{entityList}}"
                       on-entity-search="{{entitySearchListener}}"
                       on-entity-add="{{entityAddListener}}"
                       on-entity-edit="{{entityEditListener}}"></user-list>


            <user-edit entity="{{entity}}" name="entityEdit"
                       on-entity-save="{{onSave}}"
                       on-entity-delete="{{onDelete}}"
                       on-entity-cancel="{{onCancel}}">

                       </user-edit>

        </core-animated-pages>

        <paper-toast id="toast_save_ok" class="capsule" text="Entity Save."></paper-toast>
        <paper-toast id="toast_save_ko" class="capsule toast-error" text="Error in saving Entity"></paper-toast>


    </template>
    <script>

        Polymer('user-admin', {
            entityId: undefined,
            entity: undefined,
            entityList : [],
            pageSelected: 'entityList',
            ready: function () {
                this.openList();
            },

            openList : function () {
                this.pageSelected = 'entityList';
                this.entitySearchListener();
            },
            openEdit : function() {
                this.pageSelected = 'entityEdit';
            },
            entitySearchListener : function() {
                var that = this;
                this.$.user_service.searchAll(function (resp) {
                    console.log("Response Search : " + resp);
                    console.dir(resp);
                    that.entityList=resp.hits;
                });
            },
            entityEditListener: function (e) {
                var entityId = e.detail._id;
                console.log("On Entity Edit : ", entityId);
                // Select Edit
                this.pageSelected = 'entityEdit';
                this.entityId = entityId;
                this.$.user_service.entityGetById(entityId);

            },
            entityAddListener : function(e) {
                this.pageSelected = 'entityEdit';
                this.entity = {
                   _source : {}
                };
            },
            onCancel: function (entity) {
                console.log("On Cancel");
                this.entitySearchListener();
                // Select List
                this.pageSelected = 'entityList';
                this.entityId = undefined;
                this.entity = undefined;
            },
            onSave: function (entity) {
                console.log("On Save");
                // Entity
                var that = this;
                var entityToSave = entity.detail;
                console.log("to Save : " + entityToSave);
                console.dir(entityToSave);
                this.$.user_service.entityUpdate(entityToSave, function(err, resp) {
                    // Display
                    if (err) {
                        console.dir(err);
                        console.dir(resp);
                        console.log('status : ', resp.status);
                        if (resp.status === 409){
                            console.error('TODO Manage conflict');
                        }
                        that.$.toast_save_ko.show();
                        that.openList();
                    } else if (resp) {
                        that.entityId = undefined;
                        that.entity = undefined;
                        // Display Toast
                        that.$.toast_save_ok.show();
                        console.dir(resp);

                        // Select List
                        that.openList();
                    }

                });
            },
            onDelete: function (e) {
                var that = this;
                var entityToSave = e.detail;
                var entityId = entityToSave._id;
                console.dir(entityToSave);
                console.log('Delete : '+ entityId);
                this.$.user_service.entityDelete(entityId, function(err,resp) {
                    if (err) {

                    }
                    // Select List
                    that.openList();
                });

            }


        });

    </script>


</polymer-element>