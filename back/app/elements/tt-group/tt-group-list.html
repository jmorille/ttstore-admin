<!-- -->
<link rel="import" href="../../components/polymer/polymer.html">


<link rel="import" href="../../components/core-field/core-field.html">

<link rel="import" href="../../components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../../components/core-header-panel/core-header-panel.html">


<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../components/paper-item/paper-item.html">


<link rel="import" href="../tt-es/tt-es-search.html">

<link rel="import" href="../tt-table/tt-table.html">
<link rel="import" href="../tt-table/tt-pagination.html">
<link rel="import" href="../tt-table/tt-column.html">


<polymer-element name="tt-group-list" attributes="">


    <template>


        <style>
            tt-column {
                text-transform: capitalize;
            }

            [drawer] {
                border-right: 1px solid #ccc;
                background-image: linear-gradient(60deg, #c5cae9, white);
            }

            [main] {

            }

            #filter_panel_button {
                display: none;
            }

            core-drawer-panel[narrow] #filter_panel_button {
                display: inline-block
            }


        </style>

        <tt-es-search id="service" index="users" type="user" entities="{{data}}"></tt-es-search>


        <template id="result_list">
            <div vertical layout>

                <section horizontal layout>
                    <core-field>
                        <paper-input placeHolder="Search Text" inputValue="{{searchText}}"
                                     on-input="{{onSearchSuggest}}"></paper-input>
                        <paper-icon-button icon="search" on-tap="{{searchReset}}"></paper-icon-button>
                    </core-field>
                    <paper-item id="filter_panel_button" icon="filter" label="Filters"
                                on-tap="{{toggleFilter}}">
                    </paper-item>
                </section>

                <tt-table data="{{data.hits}}" sort="{{searchOpt.sort}}"
                          on-sort="{{sortHandler}}">
                    <tt-thead>
                        <th>
                            <tt-column column="firstname" sortable="$.raw">Prénom</tt-column>
                        </th>
                        <th>
                            <tt-column column="lastname" sortable="$.raw">Nom</tt-column>
                        </th>
                        <th>
                            <tt-column column="email" sortable>Email</tt-column>
                        </th>
                    </tt-thead>
                </tt-table>


                <tt-pagination range="{{rangesize}}"
                               from="{{searchOpt.from}}" size="{{searchOpt.size}}"
                               total="{{data.hits.total}}"
                               on-change="{{pagingHandler}}">
                </tt-pagination>
            </div>
        </template>

        <template id="result_filter">
            <h2>Filter</h2>
        </template>

        <core-drawer-panel rightDrawer id="filter_panel" responsiveWidth="1024px"
                           style="height: 100vh;">
            <div drawer class="right-drawer">
                <section>
                    <template bind ref="result_filter"></template>
                </section>
            </div>
            <div main>
                <section>
                    <template bind ref="result_list"></template>
                </section>
            </div>
        </core-drawer-panel>


    </template>

    <script>
        Polymer('tt-group-list', {

            data: undefined,
            searchOpt: undefined,

            searchText: undefined,
            rangesize: 10,

            created: function () {
                //   this.searchTest = '';
//                this.entityColumns = [ { column:'firstname', sortable:'$.raw', title: 'Prénom'},
//                                       { column:'lastname', sortable:'$.raw', title: 'Nom'},
//                                       { column:'email'   }
//                                    ];
                this.searchOpt = {
                    "from": 0,
                    "size": 10,
                    "_source": ["firstname", "lastname", "email" ],
                    "sort": [  "lastname.raw:asc", "firstname.raw:asc" ]
                };

            },
            ready: function () {

            },
            toggleFilter: function () {
                this.$.filter_panel.togglePanel();
            },
            search: function (optToSave) {
                var that = this;
                // Save Options
                if (optToSave) {
                    this.$.service.copyProperties(optToSave, this.searchOpt, true);
                }
                // Clone Search Options to send
                var searchOpt = this.$.service.copyProperties(this.searchOpt);
                // Add Search Criteria
                if (this.searchText) {
                    searchOpt.body = ejs.Request().query(ejs.MatchQuery('firstname', this.searchText));
                }
                // Search Service
                this.$.service.entitySearch(searchOpt, function (err, resp) {
                    console.log("Search Result for ", searchOpt);
                });
            },
            searchReset: function () {
                this.search({
                    from: 0
                });
            },
            sortHandler: function (event, data, sender) {
                this.searchOpt.sort = [ data.column + ":" + data.order ];
                this.$.service.entitySearch(this.searchOpt);
            },
            pagingHandler: function (e, detail, sender) {
                this.$.service.entitySearch(this.searchOpt);
            }


        });
    </script>
</polymer-element>