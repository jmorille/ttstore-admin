
<link rel="import" href="../../components/core-style/core-style.html">


<link rel="import" href="../../components/core-ajax/core-ajax.html">
<link rel="import" href="../../components/ajax-form/ajax-form.html">


<link rel="import" href="tt-crud-menu.html">


<core-style id="tt-group-edit">
    .toast-error {
       background-color: {{g.paperInput.invalidColor}};
    }

</core-style>

<polymer-element name="tt-crud-edit"    attributes="entityid data index">
<template>

    <core-ajax id="service_get" url="/s/{{index}}/{{entityid}}" handleAs="json"
               contentType="application/json"
               response="{{data}}"
               method="GET"
               on-core-error="{{handleError}}"
               on-core-response="{{handleGetResponse}}">
    </core-ajax>



    <core-style ref="tt-group-edit"></core-style>


    <tt-crud-menu save="{{isSaveEnabled}}"
                  on-tap-delete="{{onDelete}}" on-tap-save="{{onSaveButton}}" on-tap-close="{{onClose}}">

    </tt-crud-menu>

    <section  vertical layout>

        <content id="content"></content>

    </section>


</template>

<script>
Polymer('tt-crud-edit', {
    // Config
    autosave: '',
    autocreate: '',
    validateautofocus : '',
    // On Save : Reload the Data
    reloadOnSave: false,
    // Model
    entityid: '',
    data: data = undefined,
    dataOri: undefined,
    // Crud Menu Status
    isSaveEnabled: true,

    //
    ready: function () {
    },

    detached: function () {
    },

    observe: {
        'data._version': 'dataChanged'
    },
    onSaveButton: function () {
        console.log("----------- Click on save");
      this.save();
    },
    save : function () {
        var isValid =  this.checkValidity();
        console.log("----------- check Validity ", isValid);
    },
    checkValidity: function () {
        var childNodes = this.getFornInputField();
        var errorNodes = Array.prototype.filter.call(childNodes, function (childNode) {
            if (typeof childNode['checkValidity'] === 'function') {
                return  !childNode['checkValidity']();
            }
            return false;
        });
        return true;
    },
    getFornInputField: function () {
        console.dir(this.$.content);
        var childNodes = this.$.content.shadowRoot.querySelectorAll('*');
        var inputFieldNodes = Array.prototype.filter.call(childNodes, function (childNode) {
            if (typeof childNode['checkValidity'] === 'function') {
                console.log("childNode", childNode);
                return true;
            };
            return false;
        });
        return inputFieldNodes;
    },


    createEmptyEntity: function () {
        return {
            _id: undefined,
            _version: undefined,
            _source: {}
        };
    },

    entityidChanged: function (oldValue, newValue, args) {
        //console.log("entityidChanged for ", this.entityid);
        if (this.entityid === '' || this.entityid === null) {
            // Blank case, no model to create
        } else if (this.entityid === undefined) {
            // Create Mode
            this.data = this.createEmptyEntity();
            //  console.log("entityidChanged create empty data ", this.data);
        } else if (!this.data || !this.data._id || this.data._id !== this.entityid) {
            // Update Mode
            this.entityGet();
            //  console.log("entityidChanged load data ", this.entityid);
        }
    },
    dataChanged: function (oldValue, newValue, args) {


    },

    entityGet: function () {
        this.$.service_get.go();
    },


    onFormInvalid : function (e) {
        e.detail.forEach(function(badEl) {
            // handle invalid element
            console.log("invalid element",  badEl);
        });


    },


    handleError: function (resp) {
        this.fire("error", {
            error: resp,
            status: resp.status
        });
    },
    handleGetResponse: function (resp) {
        var detail = resp.detail;
        this.fire("entity-get", {
            response: detail.response,
            status: detail.xhr.status
        })
    }


});

</script>
</polymer-element>