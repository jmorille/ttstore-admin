<link rel="import" href="../../bower_components/polymer/polymer.html">


<polymer-element name="admin-search" attributes="">
  <template>

    <style>
      .searchBox {
        width: 400px;
      }

    </style>

    <template id="request_query">
      <section horizontal layout>
        <tt-input-search class="searchBox" value="{{searchText}}" on-search-input={{searchReset}}"></tt-input-search>

        <paper-icon-button icon="add" label="Add" on-tap="{{addButtonHandler}}"></paper-icon-button>
        <paper-icon-button id="filter_panel_button" icon="filter-list" label="Filters" on-tap="{{toggleFilter}}"></paper-icon-button>
      </section>
    </template>

    <template id="resultList">
      <div>
        <tt-table-flexbox data="{{data.hits.hits}}" sort="{{searchOpt.sort}}" on-sort="{{sortHandler}}">
          <tt-column column="lastname" sortable="$.raw" rowClass="u-Flex-grow4">Nom</tt-column>
          <tt-column column="firstname" sortable="$.raw" rowClass="u-Flex-grow4">Prénom</tt-column>
        </tt-table-flexbox>
      </div>
      <div>
        <tt-paginator range="{{rangeSize}}"
                      from="{{searchOpt.from}}" size="{{searchOpt.size}}"
                      total="{{data.hits.total}}"
                      on-change="{{pagingHandler}}">
        </tt-paginator>
      </div>
    </template>


    <div main flex>
      <template bind ref="request_query"></template>
      <template if="{{data.hits.total}}">
        <div><em>{{data.hits.total}} records found in {{data.took}} ms</em></div>
      </template>
      <div>
        <tt-es-aggs-selected aggs="{{searchOptAggs}}" on-agg-delete="{{handleAggDelete}}"
                             filterLabel="{{searchOptAggLabels}}"></tt-es-aggs-selected>
      </div>
      <div>
        <tt-es-aggs aggs="{{data.aggregations}}" on-agg-select="{{handleAggAdd}}"
                    filterLabel="{{searchOptAggLabels}}"></tt-es-aggs>
      </div>
      <template bind ref="resultList"></template>
    </div>


    <tt-lodash></tt-lodash>
    <tt-es-search id="service" endpoint="/s/users/_search" options="{{searchOpt}}" response="{{data}}"></tt-es-search>

  </template>

  <script>

    Polymer({
      // Search Datas
      data: undefined,
      searchOptDefault: undefined,

      // Search Option
      searchOpt: undefined,
      searchText: undefined,
      searchOptAggs: undefined,
      searchOptAggLabels: undefined,
      rangeSize: 10,

      created: function () {
        this.searchOptDefault = {
          "from": 0,
          "size": 20,
          "_source": ["firstname", "lastname", "email"],
          "sort": ["_score"]
        };
        this.searchOpt = _.cloneDeep(this.searchOptDefault);

        this.expectedAggs = [
          {
            name: 'firstname',
            aggregation: ejs.TermsAggregation('firstname').field('firstname.raw').order('_count', 'desc')
          },
          {
            name: 'lastname',
            aggregation: ejs.TermsAggregation('lastname').field('lastname.raw').order('_count', 'desc')
          }
        ];
        this.searchOptAggs = [];
        this.searchOptAggLabels = {
          firstname: 'Prénom',
          lastname: 'Nom'
        };
      },
      // --- App Lyfe Cycle
      // ------------------
      pageSelected: function () {
        console.log('Life Cycle : pageSelected');
        this.search();
      },
      pageUnselected: function () {
        console.log('Life Cycle : pageUnselected');
        this.data = undefined;
      },

      // --- List Action
      // ------------------
      entityAddHandler: function (event, data, sender) {
        console.log("entityAddHandler", data);
      },

      entityEditHandler: function (event, data, sender) {
        console.log("entityEditHandler", data);
      },

      // --- Search Event
      // ------------------
      sortHandler: function (event, data, sender) {
        var sort = data.column + ":" + data.order;
        // compute merging sort
        if (Array.isArray(this.searchOpt.sort)) {
          var filterSort = this.searchOpt.sort.filter(function (elt) {
            var eltColSortSep = elt.lastIndexOf(':');
            var eltColSort = eltColSortSep > -1 ? elt.slice(0, eltColSortSep) : elt;
            return eltColSort !== data.column;
          });
          sort = [sort].concat(filterSort);
        }
        // Do search

        this.search({sort: sort});
      },

      pagingHandler: function (event, data, sender) {
        //console.log("----- pagingHandler", detail);
        this.search();
      },

      // --- Search Aggs
      // ------------------
      handleAggAdd: function (e, data, sender) {
        console.log("----- Agg Add", data);
        this.searchOptAggs.push(data);
        this.search();
      },
      handleAggDelete: function (e, data, sender) {
        console.log("----- Agg Delete", data);
        this.search();
      },

      // --- Search Action
      // ------------------
      searchReset: function () {
        this.searchOpt = _.cloneDeep(this.searchOptDefault);
        this.search();
      },

      search: function (optToSave) {
        var that = this;
        // Save Options
        if (optToSave) {
          this.searchOpt = _.merge(this.searchOpt, optToSave);
        }
        console.log('sortHandler -->', this.searchOpt.sort);
        // Add Search Criteria
        this.searchOpt.body = this.searchQueryBody();

        // Search Service
        this.$.service.entitySearch();
      },

      // --- Search Logic
      // ------------------
      searchQueryBody: function () {
        var query = undefined;
        var body = undefined;
        // Query : http://docs.fullscale.co/elasticjs/
        if (this.searchText) {
          query = ejs.QueryStringQuery(this.searchText).defaultOperator('and');
        } else {
          query = ejs.MatchAllQuery();
        }

        // Facets Filter
        // ----------------
        var facetFilter = this.searchOptAggs.reduce(function (previous, current, index, array) {
          var facetFilter = ejs.TermFilter(current.name + '.raw', current.value);
          console.log("facetFilter : ", facetFilter.toJSON());
          if (!previous) {
            previous = ejs.BoolFilter();
          }
          return previous.must(facetFilter);
        }, undefined);

        if (facetFilter) {
          console.log("boolFilter : ", facetFilter.toJSON());
          query = ejs.FilteredQuery(query, facetFilter);
        }


        // Create Es Request
        // ----------------
        body = ejs.Request().query(query).from(this.searchOpt.from).size(this.searchOpt.size);

        // Agg Aggregations
        // ----------------

        // Filter Aggs
        var that = this;
        var expectedAggs = this.expectedAggs.filter(function (elt) {
          return !that.searchOptAggs.some(function (optAgg) {
            return elt.name === optAgg.name;
          });
        });
        // Register Aggs
        expectedAggs.forEach(function (elt) {
          body.aggregation(elt.aggregation);
        });


        console.log("Elastic.js Body", body.toJSON());
        return body.toJSON();
      }



//      handleVoiceRecognition: function (event, data) {
//        this.searchText = data.result;
//        _id.log('voice-recognition', data.result);
//      },
//      startVoiceRecognition: function () {
//        this.$.voiceRecognition.start();
//      }

    });

  </script>
</polymer-element>
